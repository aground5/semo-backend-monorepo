# 토스페이먼츠 v2 자동결제 정보 가이드

## 1. 핵심 개념

### 1.1 빌링키(Billing Key)

**정의:**

- 고객의 카드번호, 유효기간, CVC 등 결제 정보를 암호화한 값
- 실제로는 결제기관이 고객의 결제 정보를 고유 식별 토큰과 매핑하고, 이를 암호화한 값
- 누군가 빌링키를 복호화해도 고객의 실제 결제 정보는 알 수 없음

**중요 특징:**

- **한 번 발급되면 재조회 불가능** → 발급 즉시 반드시 안전하게 저장 필수
- 빌링키는 유효기간이 없음 (등록한 카드가 유효하면 빌링키도 계속 유효)
- 카드 재발급/유효기간 만료 시 새로운 빌링키 재발급 필요 (갱신 기능 없음)
- 빌링키 중복 발급 방지 기능 없음 (한 카드에 여러 빌링키 발급 가능)
- 빌링키 삭제 API 제공되지 않음 (DB에서 삭제 후 사용 중단)

---

### 1.2 customerKey

**정의:**

- 상점에서 관리하는 고객 식별키
- billingKey와 1:1 매핑되어 결제 시 함께 전달되어야 함

**생성 규칙:**

- UUID와 같이 충분히 무작위적인 고유 값으로 생성
- **유추 가능한 값 사용 금지:**
  - 이메일 주소 ❌
  - 전화번호 ❌
  - 자동 증가 숫자 ❌
  - 사용자 아이디 ❌
- 영문 대소문자, 숫자, 특수문자(-, \_, =, ., @) 중 최소 1개 포함
- 최소 2자 ~ 최대 300자

**보안 원리:**

- 빌링키가 노출되어도 매핑된 customerKey를 모르면 결제 불가능
- 결제 시 billingKey + customerKey 둘 다 필요

---

### 1.3 지원 결제수단

**현재 지원:**

- 국내 신용/체크카드만 지원

**미지원:**

- 간편결제 (토스페이, 카카오페이, 네이버페이 등)
- 해외 간편결제 (PayPal 등)
- 해외 카드

---

### 1.4 스케줄링

**토스페이먼츠는 스케줄링 기능을 제공하지 않음**

- 구독 주기에 맞춰 자동결제를 실행하는 스케줄링은 직접 구현 필요
- 매월/매년 특정 시점에 자동결제 승인 API를 직접 호출해야 함

**참고:**

- https://www.tosspayments.com/blog/articles/구독-결제-서비스-간단히-구현하기-2-스케줄링

---

## 2. 보안 요구사항

### 2.1 빌링키 보호

**필수 보안 조치:**

- AES-256-GCM 알고리즘으로 암호화 (KISA 권고)
- IV(초기화 벡터)는 매번 랜덤 생성
- 빌링키는 평문으로 절대 저장 금지
- 복호화는 결제 실행 시에만 수행
- 빌링키 접근 시마다 감사 로그 기록

**접근 로그 관리:**

- 접근 시각, 접근자, 접근 목적, IP 주소 기록
- 최소 2년 보관 (개인정보보호법 준수)

---

### 2.2 환경변수 관리

**필수 환경변수:**

```
ENCRYPTION_KEY=64자리_랜덤_Hex
TOSS_CLIENT_KEY=test_ck_... (테스트) / live_ck_... (실서비스)
TOSS_SECRET_KEY=test_sk_... (테스트) / live_sk_... (실서비스)
```

**보안 원칙:**

- [ ] 환경변수에 암호화 키 저장 (소스코드에 하드코딩 금지)
- [ ] .env 파일을 .gitignore에 추가
- [ ] 서비스 계정 2FA(이중 인증) 활성화
- [ ] 프로젝트 접근 권한 최소화
- [ ] TOSS_SECRET_KEY 노출 금지 (GitHub, 로그, 브라우저 등)
- [ ] 시크릿 키는 서버 사이드에서만 사용

---

### 2.3 API 인증

**Basic Authentication:**

- 시크릿 키 뒤에 콜론(:) 추가 후 Base64 인코딩
- 예: `Base64(시크릿키:)`
- 비밀번호 없음을 표시하기 위해 콜론 필수

**HTTPS 통신:**

- 모든 API 호출은 HTTPS만 사용
- TLS 버전 1.2 이상

---

## 3. 법적 준수 사항

### 3.1 개인정보보호법

**필수 조치:**

- [ ] 개인정보 처리방침에 빌링키 저장 명시
- [ ] AES-256 이상 암호화 저장
- [ ] 접근 로그 2년 이상 보관
- [ ] 사용자 동의 획득 (구독 약관)

---

### 3.2 전자금융거래법

**필수 절차:**

- [ ] 토스페이먼츠와 자동결제 계약 체결 필요
  - 계약 전에는 NOT_SUPPORTED_METHOD 에러 발생
  - 고객센터: 1544-7772 / support@tosspayments.com
- [ ] 이용약관에 구독 조항 추가
- [ ] 결제 전 사용자에게 고지
- [ ] 결제 후 영수증 발급

---

### 3.3 구독경제법 (소비자 보호)

**참고 자료:**

- https://docs.tosspayments.com/resources/glossary/billing (구독경제 소비자 보호 방안)

---

## 4. 에러 코드 및 대응

### 4.1 계약 관련 에러

**NOT_SUPPORTED_METHOD**

- 원인: 자동결제 계약이 안 되어 있는 클라이언트 키 사용
- 대응: 토스페이먼츠 고객센터(1544-7772)로 계약 문의

---

### 4.2 빌링키 관련 에러

**NOT_MATCHES_CUSTOMER_KEY**

- 원인: customerKey와 billingKey가 매핑되지 않음
- 대응: 올바른 customerKey + billingKey 쌍 확인

**BILLING_KEY_ALREADY_DELETED**

- 원인: 삭제된 빌링키로 결제 시도
- 대응: 새로운 빌링키 재발급 필요

**INVALID_CARD_EXPIRATION**

- 원인: 카드 유효기간 만료
- 대응: 사용자에게 새 카드 등록 요청

---

### 4.3 카드사 거절 에러

**REJECT_CARD_COMPANY**

- 원인: 카드사에서 거절 (한도 초과, 카드 정지, 잔액 부족 등)
- 대응: 사용자에게 카드사 확인 또는 결제수단 변경 요청

---

### 4.4 사용자 취소 에러

**PAY_PROCESS_CANCELED**

- 원인: 사용자가 결제창에서 결제 취소
- 특징: orderId가 전달되지 않음
- 대응: 사용자에게 취소 안내

---

### 4.5 에러 참고 문서

**전체 에러 코드:**

- https://docs.tosspayments.com/reference#에러-코드

---

## 5. 테스트 환경

### 5.1 테스트 키 발급

**토스페이먼츠 개발자센터:**

- https://developers.tosspayments.com
- 회원가입 후 테스트 상점 키 자동 발급
- API 키 메뉴에서 테스트 클라이언트 키/시크릿 키 확인

---

### 5.2 테스트 환경 특징

**테스트와 라이브의 차이:**

- 테스트 키로는 실제 결제 발생하지 않음
- **테스트 환경:** 카드번호 앞 6자리(BIN)만 유효해도 빌링키 발급 가능
- **라이브 환경:** 전체 카드번호가 유효해야 빌링키 발급 가능
- 테스트 결제 내역은 개발자센터에서 확인 가능

---

## 6. 라이브 전환 체크리스트

### 6.1 계약 및 인증 정보

**사전 준비:**

- [ ] 토스페이먼츠와 자동결제 계약 완료 (1544-7772)
- [ ] 실서비스 MID(상점아이디) 발급 확인
- [ ] 실서비스 클라이언트 키/시크릿 키 발급 확인
- [ ] 환경변수를 테스트 키 → 실서비스 키로 변경

---

### 6.2 법적 문서

**필수 업데이트:**

- [ ] 개인정보 처리방침 업데이트 (빌링키 저장 명시)
- [ ] 이용약관에 구독 조항 추가
- [ ] 구독 서비스 안내 페이지 작성

---

### 6.3 시스템 준비

**전환 작업:**

- [ ] 테스트 데이터 완전 삭제
- [ ] 모니터링 설정 (에러 알림, 결제 실패 알림)
- [ ] 백업 시스템 확인
- [ ] 롤백 계획 수립

---

## 7. 주요 제약사항 요약

### 7.1 발급 관련

- ❌ 빌링키 재조회 API 없음 → 발급 즉시 저장 필수
- ❌ 빌링키 갱신 기능 없음 → 카드 재발급 시 새로 발급
- ❌ 빌링키 삭제 API 없음 → DB에서 관리
- ❌ 빌링키 중복 발급 방지 기능 없음

---

### 7.2 결제 관련

- ❌ 스케줄링 기능 미제공 → 직접 구현 필요
- ⏱️ 자동결제 승인은 최대 60초 소요 → 타임아웃 최소 60초 설정
- ⚠️ 자동결제는 정기 구독형 서비스에만 사용 (비정기 결제는 카드사 심사 어려움)

---

### 7.3 결제수단 제약

- ✅ 국내 신용/체크카드만 지원
- ❌ 간편결제 미지원
- ❌ 해외 카드 미지원

---

## 8. 구독 관리 원칙

### 8.1 구독 취소

**처리 방법:**

- 다음 결제일에 자동결제 API를 호출하지 않으면 됨
- 빌링키는 삭제하지 않음 (재개 가능)

**토스페이먼츠 공식 답변:**

- "다음 결제일에 구독을 취소한 구매자의 빌링키, customerKey로 카드 자동결제 승인 API를 호출하지 않으면 됩니다"

---

### 8.2 결제수단 변경

**처리 원칙:**

- 기존 빌링키는 비활성화 (삭제 아님)
- 새 카드로 빌링키 재발급
- 구독에 새 빌링키 연결

**주의사항:**

- 카드 유효기간 만료/재발급 시 새 빌링키 재발급 필요
- 빌링키 갱신(update) 기능 없음

---

### 8.3 구독 플랜 변경

**금액 변경:**

- 자동결제 API 호출 시 amount 파라미터를 변경된 금액으로 설정

**주기 변경:**

- 스케줄러에서 다음 결제일 재계산

---

## 9. 참고 문서

### 9.1 토스페이먼츠 v2 공식 문서

**핵심 가이드:**

- 자동결제(빌링) 이해하기: https://docs.tosspayments.com/guides/v2/billing
- 자동결제 결제창 연동: https://docs.tosspayments.com/guides/v2/billing/integration
- 빌링키 용어 설명: https://docs.tosspayments.com/resources/glossary/billing

**API 레퍼런스:**

- 코어 API 문서: https://docs.tosspayments.com/reference
- JavaScript SDK v2: https://docs.tosspayments.com/sdk/v2/js
- 에러 코드 전체 목록: https://docs.tosspayments.com/reference#에러-코드

**구현 가이드:**

- 구독 서비스 구현하기 (1) 빌링키 발급: https://velog.io/@tosspayments/구독-결제-서비스-간단히-구현하기-1-빌링키-발급하기
- 구독 서비스 구현하기 (2) 스케줄링: https://www.tosspayments.com/blog/articles/구독-결제-서비스-간단히-구현하기-2-스케줄링

---

### 9.2 지원 채널

**실시간 지원:**

- 기술지원 채팅: https://docs.tosspayments.com/support/chat
- 고객센터: 1544-7772
- 이메일: support@tosspayments.com

**커뮤니티:**

- FAQ: https://docs.tosspayments.com/resources/faq
- 개발자센터: https://developers.tosspayments.com

---

### 9.3 외부 참고 자료

- Node.js Crypto 모듈: https://nodejs.org/api/crypto.html
- 개인정보보호법: https://www.privacy.go.kr
- 전자금융거래법: https://www.law.go.kr

---

## 10. 중요 체크포인트

### 10.1 반드시 기억할 사항

**빌링키:**

- ⚠️ 발급 후 재조회 불가능 → 즉시 안전하게 저장
- ⚠️ 평문 저장 절대 금지 → AES-256-GCM 암호화 필수
- ⚠️ 갱신 기능 없음 → 카드 변경 시 재발급

**customerKey:**

- ⚠️ UUID 형태로 생성 (유추 가능한 값 금지)
- ⚠️ 빌링키와 함께 결제 시 필수

**계약:**

- ⚠️ 자동결제 계약 필수 (계약 전에는 사용 불가)
- ⚠️ 정기 구독형 서비스에만 사용

**스케줄링:**

- ⚠️ 토스페이먼츠는 스케줄링 미제공 → 직접 구현 필수

---

### 10.2 보안 체크

**필수 보안 조치:**

- [ ] 빌링키 AES-256-GCM 암호화
- [ ] IV 매번 랜덤 생성
- [ ] 환경변수로 암호화 키 관리
- [ ] 시크릿 키 노출 방지
- [ ] 접근 로그 2년 보관
- [ ] HTTPS만 사용

---

### 10.3 법적 준수

**필수 문서:**

- [ ] 개인정보 처리방침 업데이트
- [ ] 이용약관에 구독 조항 추가
- [ ] 사용자 동의 획득
